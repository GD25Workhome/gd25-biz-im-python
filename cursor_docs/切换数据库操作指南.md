# 切换数据库操作指南

## 一、问题回答

### Q1: 切换数据库后，Alembic 下的文件需要重新生成吗？

**答案：不需要！**

迁移脚本文件（`alembic/versions/*.py`）是**版本控制的一部分**，它们记录了数据库 schema 的变更历史。无论切换到哪个数据库，这些迁移脚本都应该保持不变。

**原因：**
- 迁移脚本定义了"如何创建表结构"，而不是"当前数据库的状态"
- 不同的数据库（开发、测试、生产）应该使用相同的迁移脚本来保持一致性
- 重新生成迁移脚本会丢失历史记录，可能导致版本不一致

### Q2: 切换数据库后，如何执行命令？

**答案：直接执行 `alembic upgrade head` 即可！**

Alembic 会自动：
1. 检查数据库中的 `alembic_version` 表
2. 查看当前数据库版本
3. 执行所有未执行的迁移脚本
4. 更新 `alembic_version` 表

## 二、操作步骤

### 步骤 1: 检查数据库状态

```bash
# 使用检查脚本（推荐）
python scripts/check_alembic_status.py

# 或使用 Alembic 命令
alembic current    # 查看当前版本
alembic history    # 查看迁移历史
```

**检查脚本会告诉你：**
- 数据库是否为空
- 有哪些表
- Alembic 版本表是否存在
- 缺少哪些必需的表

### 步骤 2: 执行迁移

**对于空数据库（新数据库）：**

```bash
# 直接执行迁移，创建所有表
alembic upgrade head
```

**对于已有数据的数据库：**

```bash
# 先检查当前版本
alembic current

# 如果版本不是最新的，执行升级
alembic upgrade head

# 如果需要升级到特定版本
alembic upgrade <revision_id>
```

### 步骤 3: 验证结果

```bash
# 再次检查数据库状态
python scripts/check_alembic_status.py

# 或使用验证脚本
python scripts/verify_tables.py
```

## 三、实际案例

### 案例：切换到新的空数据库

**场景：** 你切换到了一个新的空数据库（如从开发环境切换到测试环境）

**操作：**

1. **更新数据库配置**
   ```bash
   # 在 .env 文件中更新 DATABASE_URL
   DATABASE_URL=postgresql://user:password@localhost:5433/new_database
   ```

2. **检查数据库状态**
   ```bash
   python scripts/check_alembic_status.py
   ```
   
   输出示例：
   ```
   数据库为空，这是新数据库
   建议执行: alembic upgrade head
   ```

3. **执行迁移**
   ```bash
   alembic upgrade head
   ```
   
   输出示例：
   ```
   INFO  [alembic.runtime.migration] Running upgrade  -> 25c8f48abee5, Create initial tables
   ```

4. **验证结果**
   ```bash
   python scripts/check_alembic_status.py
   ```
   
   应该看到所有表都已创建。

### 案例：数据库已有部分表

**场景：** 数据库中有一些表，但没有 `alembic_version` 表（可能是手动创建的）

**操作：**

1. **检查当前状态**
   ```bash
   python scripts/check_alembic_status.py
   ```

2. **如果表结构正确，手动创建版本记录**
   ```sql
   -- 连接到数据库
   CREATE TABLE alembic_version (
       version_num VARCHAR(32) NOT NULL PRIMARY KEY
   );
   
   -- 插入当前版本（查看迁移脚本的 revision ID）
   INSERT INTO alembic_version (version_num) VALUES ('25c8f48abee5');
   ```

3. **或者，如果表结构不正确，删除所有表后重新迁移**
   ```sql
   -- 危险操作！会删除所有数据
   DROP SCHEMA public CASCADE;
   CREATE SCHEMA public;
   ```
   
   然后执行：
   ```bash
   alembic upgrade head
   ```

## 四、常见问题

### 问题 1: 迁移脚本执行失败，提示表不存在

**原因：** 迁移脚本试图删除不存在的表（通常是从旧数据库迁移过来的）

**解决：** 已修复！迁移脚本现在会先检查表是否存在再删除。

如果遇到类似问题，可以：
1. 检查迁移脚本中的 `drop_table` 操作
2. 添加表存在性检查（参考已修复的脚本）

### 问题 2: 迁移脚本执行失败，提示索引不存在

**原因：** 迁移脚本试图删除不存在的索引

**解决：** 迁移脚本已添加索引存在性检查。

### 问题 3: 如何回滚迁移？

```bash
# 回滚一个版本
alembic downgrade -1

# 回滚到特定版本
alembic downgrade <revision_id>

# 回滚到基础版本（删除所有表，危险！）
alembic downgrade base
```

**注意：** 回滚会删除数据，请谨慎操作！

### 问题 4: 如何查看迁移脚本会执行什么 SQL？

```bash
# 查看升级 SQL（不执行）
alembic upgrade head --sql

# 查看降级 SQL（不执行）
alembic downgrade -1 --sql

# 保存到文件
alembic upgrade head --sql > migration.sql
```

## 五、最佳实践

### 1. 切换数据库前

- ✅ 备份原数据库（生产环境必须）
- ✅ 确认新数据库连接配置正确
- ✅ 检查迁移脚本是否完整

### 2. 切换数据库后

- ✅ 先检查数据库状态（使用检查脚本）
- ✅ 执行迁移前确认数据库为空或已备份
- ✅ 执行迁移后验证结果
- ✅ 检查所有必需的表和索引

### 3. 日常开发

- ✅ 修改模型后，使用 `alembic revision --autogenerate` 生成迁移脚本
- ✅ 检查生成的脚本，确保正确
- ✅ 在测试环境先验证迁移脚本
- ✅ 提交迁移脚本到版本控制

## 六、快速参考

```bash
# 检查数据库状态
python scripts/check_alembic_status.py

# 查看当前版本
alembic current

# 查看迁移历史
alembic history

# 执行迁移（升级到最新）
alembic upgrade head

# 生成新的迁移脚本
alembic revision --autogenerate -m "描述信息"

# 回滚一个版本
alembic downgrade -1

# 验证表结构
python scripts/verify_tables.py
```

## 七、总结

**切换数据库后的标准流程：**

1. ✅ **不需要重新生成迁移脚本** - 迁移脚本是版本控制的一部分
2. ✅ **更新数据库配置** - 修改 `.env` 文件中的 `DATABASE_URL`
3. ✅ **检查数据库状态** - 使用 `check_alembic_status.py` 脚本
4. ✅ **执行迁移** - 运行 `alembic upgrade head`
5. ✅ **验证结果** - 再次检查数据库状态

**记住：迁移脚本是代码的一部分，应该提交到 Git，而不是重新生成！**
