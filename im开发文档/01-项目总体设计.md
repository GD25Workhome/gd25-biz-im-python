# 轻量级 IM 服务 - 项目总体设计

## 一、项目概述

### 1.1 项目背景

本项目是一个轻量级即时通讯（IM）服务，主要面向独立开发者，提供用户消息发送和 AI 自动回复功能。项目采用 Python 技术栈，使用 FastAPI、LangChain、Celery 等框架实现。

### 1.2 核心需求

1. **用户发消息、AI 回复消息场景下的消息管理**
   - 用户通过 WebSocket 或 HTTP API 发送消息
   - AI 自动回复用户消息
   - 消息的存储和查询

2. **压测 IM 依赖的 AI 回复架构**
   - 支持高并发场景下的性能测试
   - 使用 MQ 中间件实现异步处理
   - 验证系统在高并发下的稳定性

### 1.3 功能范围

#### ✅ 核心功能
- 用户发送消息（WebSocket + HTTP API）
- AI 自动回复消息
- 消息存储和查询
- AI 聊天记录管理
- 实时消息推送（WebSocket）

#### ❌ 不包含功能
- 群组管理
- 多端消息同步
- 离线消息推送
- 已读回执
- 消息撤回
- 复杂的权限管理

### 1.4 技术选型

```
技术栈：
├── FastAPI              # Web 框架（支持 WebSocket）
├── SQLAlchemy           # ORM 框架
├── Alembic              # 数据库迁移
├── LangChain            # AI 框架
├── Celery               # 异步任务队列（MQ）
├── Redis                # 缓存和消息队列
├── PostgreSQL/MySQL     # 数据库
└── Locust               # 压测框架
```

---

## 二、系统架构设计

### 2.1 整体架构

```
┌─────────────┐
│  客户端     │ (WebSocket / HTTP)
└──────┬──────┘
       │
       ↓
┌─────────────────────┐
│  FastAPI 服务       │
│  ┌───────────────┐  │
│  │ HTTP API      │  │
│  └──────┬────────┘  │
│         │            │
│  ┌──────┴────────┐  │
│  │ WebSocket     │  │
│  └──────┬────────┘  │
└─────────┼───────────┘
          │
          ↓
┌─────────────────────┐
│  消息服务层         │
│  ┌───────────────┐  │
│  │ 消息接收      │  │
│  └──────┬────────┘  │
│         │            │
│  ┌──────┴────────┐  │
│  │ 发送到 MQ     │  │
│  └──────┬────────┘  │
└─────────┼───────────┘
          │
          ↓
┌─────────────────────┐
│  Redis (MQ)         │
└──────┬──────────────┘
       │
       ↓
┌─────────────────────┐
│  Celery Worker      │
│  ┌───────────────┐  │
│  │ 消费消息       │  │
│  └──────┬────────┘  │
│         │            │
│  ┌──────┴────────┐  │
│  │ AI 回复服务   │  │
│  └──────┬────────┘  │
└─────────┼───────────┘
          │
          ↓
┌─────────────────────┐
│  LangChain          │
│  ┌───────────────┐  │
│  │ 调用 AI API   │  │
│  └──────┬────────┘  │
└─────────┼───────────┘
          │
          ↓
┌─────────────────────┐
│  数据库 (PostgreSQL)│
│  ┌───────────────┐  │
│  │ 消息表         │  │
│  │ AI聊天记录表   │  │
│  └───────────────┘  │
└─────────────────────┘
```

### 2.2 核心流程

#### 2.2.1 用户发送消息流程

```
1. 用户通过 WebSocket 或 HTTP API 发送消息
   ↓
2. FastAPI 接收消息
   ↓
3. 保存消息到数据库（异步）
   ↓
4. 发送消息到 Redis MQ（Celery）
   ↓
5. 立即返回响应给用户
   ↓
6. Celery Worker 消费消息
   ↓
7. 调用 AI 服务生成回复
   ↓
8. 保存 AI 回复到数据库
   ↓
9. 通过 WebSocket 推送 AI 回复给用户
```

#### 2.2.2 AI 回复流程

```
1. Celery Worker 接收到消息
   ↓
2. 构建 AI 请求（包含用户消息和历史消息）
   ↓
3. 调用 LangChain 调用 AI API
   ↓
4. 接收 AI 回复（流式或非流式）
   ↓
5. 保存 AI 聊天记录到数据库
   ↓
6. 通过 WebSocket 推送回复给用户
```

### 2.3 技术架构分层

```
┌─────────────────────────────────────┐
│  表现层 (Presentation Layer)       │
│  - FastAPI HTTP API                 │
│  - WebSocket Handler                │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  业务层 (Business Layer)            │
│  - MessageService                   │
│  - AIService                        │
│  - WebSocketService                 │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  数据访问层 (Data Access Layer)     │
│  - MessageRepository                │
│  - AIChatRecordRepository           │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  基础设施层 (Infrastructure Layer)  │
│  - Database (PostgreSQL)            │
│  - Redis (MQ)                       │
│  - Celery                           │
└─────────────────────────────────────┘
```

---

## 三、模块划分

### 3.1 核心模块

1. **Web API 模块**
   - HTTP API 接口
   - WebSocket 连接管理
   - 请求验证和错误处理

2. **消息服务模块**
   - 消息接收和处理
   - 消息存储
   - 消息查询

3. **AI 服务模块**
   - AI 回复生成
   - LangChain 集成
   - AI 聊天记录管理

4. **异步任务模块**
   - Celery 任务定义
   - 消息队列处理
   - 任务监控

5. **数据访问模块**
   - 数据库模型定义
   - Repository 模式实现
   - 数据库迁移

6. **配置管理模块**
   - 应用配置
   - 环境变量管理
   - 日志配置

### 3.2 模块依赖关系

```
Web API 模块
    ↓ 依赖
消息服务模块
    ↓ 依赖
数据访问模块
    ↓ 依赖
数据库

Web API 模块
    ↓ 依赖
异步任务模块
    ↓ 依赖
AI 服务模块
    ↓ 依赖
LangChain

异步任务模块
    ↓ 依赖
Redis (MQ)
```

---

## 四、数据库设计

### 4.1 数据库选型

- **主数据库**：PostgreSQL（推荐）或 MySQL
- **缓存/消息队列**：Redis

### 4.2 核心表设计

#### 4.2.1 消息表 (messages)

```sql
CREATE TABLE messages (
    id BIGSERIAL PRIMARY KEY,
    message_id VARCHAR(64) NOT NULL UNIQUE COMMENT '消息唯一标识',
    session_id VARCHAR(48) NOT NULL COMMENT '会话ID（用户ID）',
    from_user_id VARCHAR(48) NOT NULL COMMENT '发送人ID',
    msg_type VARCHAR(32) NOT NULL DEFAULT 'TEXT' COMMENT '消息类型：TEXT/AI_REPLY',
    msg_content TEXT NOT NULL COMMENT '消息内容',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_session_id (session_id),
    INDEX idx_from_user_id (from_user_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='消息表';
```

#### 4.2.2 AI 聊天记录表 (ai_chat_records)

```sql
CREATE TABLE ai_chat_records (
    id BIGSERIAL PRIMARY KEY,
    record_id VARCHAR(64) NOT NULL UNIQUE COMMENT '记录唯一标识',
    session_id VARCHAR(48) NOT NULL COMMENT '会话ID',
    user_message_id VARCHAR(64) NOT NULL COMMENT '用户消息ID',
    ai_message_id VARCHAR(64) COMMENT 'AI回复消息ID',
    request_content TEXT COMMENT '请求内容（JSON格式）',
    response_content TEXT COMMENT '响应内容（JSON格式）',
    status TINYINT NOT NULL DEFAULT 0 COMMENT '状态：0-处理中，1-成功，2-失败',
    duration_ms BIGINT COMMENT '处理耗时（毫秒）',
    error_message VARCHAR(500) COMMENT '错误信息',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_session_id (session_id),
    INDEX idx_user_message_id (user_message_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='AI聊天记录表';
```

---

## 五、API 设计概览

### 5.1 HTTP API

- `POST /api/message/send` - 发送消息
- `GET /api/message/list` - 获取消息列表
- `GET /api/message/{message_id}` - 获取单条消息
- `GET /api/ai/records` - 获取 AI 聊天记录

### 5.2 WebSocket API

- `ws://host/ws/{user_id}` - WebSocket 连接
- 消息格式：JSON

详细 API 文档见：`03-API接口文档.md`

---

## 六、非功能性需求

### 6.1 性能要求

- **响应时间**：HTTP API 响应时间 < 200ms
- **并发支持**：支持至少 100 并发用户
- **AI 回复时间**：AI 回复生成时间 < 30s（取决于 AI 服务）

### 6.2 可靠性要求

- **可用性**：99% 可用性
- **数据一致性**：保证消息不丢失
- **错误处理**：完善的错误处理和日志记录

### 6.3 可扩展性

- **水平扩展**：支持多实例部署
- **MQ 扩展**：支持增加 Celery Worker
- **数据库扩展**：支持数据库读写分离

---

## 七、开发环境要求

### 7.1 开发工具

- Python 3.10+
- PostgreSQL 14+ 或 MySQL 8.0+
- Redis 6.0+
- Git

### 7.2 Python 依赖

- FastAPI 0.104+
- SQLAlchemy 2.0+
- LangChain 0.1+
- Celery 5.3+
- Redis 5.0+
- Pydantic 2.0+

---

## 八、部署架构

### 8.1 开发环境

```
单机部署：
├── FastAPI 服务（端口 8000）
├── Celery Worker（1个）
├── PostgreSQL（本地）
└── Redis（本地）
```

### 8.2 生产环境（可选）

```
多实例部署：
├── FastAPI 服务（Nginx 负载均衡）
├── Celery Worker（多个，根据负载调整）
├── PostgreSQL（主从复制）
└── Redis（集群模式）
```

---

## 九、安全考虑

### 9.1 认证授权

- **用户认证**：支持 Token 认证（JWT）
- **WebSocket 认证**：连接时验证 Token

### 9.2 数据安全

- **数据加密**：敏感数据加密存储
- **SQL 注入防护**：使用 ORM 防止 SQL 注入
- **XSS 防护**：输入验证和转义

---

## 十、监控和日志

### 10.1 日志

- **日志级别**：DEBUG、INFO、WARNING、ERROR
- **日志格式**：JSON 格式，便于分析
- **日志存储**：文件 + 可选 ELK 栈

### 10.2 监控指标

- **API 响应时间**
- **消息处理量**
- **AI 回复成功率**
- **Celery 任务队列长度**
- **数据库连接数**

---

**文档版本**：v1.0  
**创建时间**：2025-01-27  
**最后更新**：2025-01-27

