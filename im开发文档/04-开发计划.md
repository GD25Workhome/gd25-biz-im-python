# 轻量级 IM 服务 - 开发计划

## 一、开发计划概述

### 1.1 总体目标

开发一个轻量级 IM 服务，支持用户消息发送和 AI 自动回复功能，使用 Python + FastAPI + LangChain + Celery 技术栈。

### 1.2 开发原则

- **快速迭代**：每个里程碑完成后可独立测试验证
- **模块化开发**：各模块相对独立，便于并行开发
- **文档驱动**：代码与文档同步更新
- **测试验证**：每个里程碑包含测试验证环节

### 1.3 开发周期

预计总开发时间：**3-4 周**

---

## 二、里程碑划分

### 里程碑 1：项目基础搭建（3-4 天）

**目标**：完成项目基础框架搭建，包括项目结构、配置管理、数据库连接等。

#### 任务清单

1. **项目初始化**
   - [ ] 创建项目目录结构
   - [ ] 初始化 Git 仓库
   - [ ] 创建 `requirements.txt`
   - [ ] 创建 `.env.example`
   - [ ] 创建 `README.md`

2. **配置管理模块**
   - [ ] 实现 `app/config.py`（配置管理）
   - [ ] 实现环境变量管理
   - [ ] 实现配置验证

3. **数据库模块**
   - [ ] 实现 `app/db/database.py`（数据库连接）
   - [ ] 实现 `app/db/base.py`（基础模型）
   - [ ] 配置 Alembic 数据库迁移
   - [ ] 创建数据库表结构（messages, ai_chat_records）

4. **工具模块**
   - [ ] 实现 `app/utils/logger.py`（日志工具）
   - [ ] 实现 `app/utils/id_generator.py`（ID 生成器）

5. **主应用入口**
   - [ ] 实现 `app/main.py`（FastAPI 应用）
   - [ ] 配置 CORS
   - [ ] 实现健康检查接口

#### 验收标准

- [ ] 项目可以正常启动
- [ ] 数据库连接正常
- [ ] 健康检查接口返回正常
- [ ] 日志输出正常

#### 测试验证

```bash
# 1. 启动服务
uvicorn app.main:app --reload

# 2. 测试健康检查
curl http://localhost:8000/health

# 3. 检查日志输出
# 应该看到服务启动日志
```

---

### 里程碑 2：数据模型和仓储层（2-3 天）

**目标**：完成数据模型定义、Repository 模式实现。

#### 任务清单

1. **数据模型**
   - [ ] 实现 `app/models/message.py`（消息模型）
   - [ ] 实现 `app/models/ai_chat_record.py`（AI 聊天记录模型）
   - [ ] 创建数据库迁移脚本
   - [ ] 执行数据库迁移

2. **Schema 定义**
   - [ ] 实现 `app/schemas/message.py`（消息 Schema）
   - [ ] 实现 `app/schemas/ai.py`（AI Schema）
   - [ ] 实现数据验证规则

3. **Repository 层**
   - [ ] 实现 `app/repositories/message_repository.py`
   - [ ] 实现 `app/repositories/ai_chat_repository.py`
   - [ ] 实现基础 CRUD 操作

#### 验收标准

- [ ] 数据库表创建成功
- [ ] Repository 可以正常进行 CRUD 操作
- [ ] Schema 验证正常

#### 测试验证

```python
# 测试 Repository
from app.db.database import SessionLocal
from app.repositories.message_repository import MessageRepository
from app.schemas.message import MessageCreate

db = SessionLocal()
repo = MessageRepository(db)

# 创建消息
message_create = MessageCreate(
    content="测试消息",
    session_id="test_user"
)
message = repo.create(message_create, "test_user")
print(f"Created message: {message.message_id}")

# 查询消息
found = repo.get_by_id(message.message_id)
print(f"Found message: {found.msg_content}")

# 查询消息列表
messages, total = repo.get_by_session("test_user", 1, 20)
print(f"Total messages: {total}")
```

---

### 里程碑 3：消息服务 API（2-3 天）

**目标**：完成消息相关的 HTTP API 接口。

#### 任务清单

1. **消息服务层**
   - [ ] 实现 `app/services/message_service.py`
   - [ ] 实现消息发送逻辑
   - [ ] 实现消息查询逻辑

2. **API 路由**
   - [ ] 实现 `app/api/message.py`
   - [ ] 实现 `POST /api/message/send` 接口
   - [ ] 实现 `GET /api/message/{message_id}` 接口
   - [ ] 实现 `GET /api/message/list` 接口

3. **错误处理**
   - [ ] 实现统一错误处理
   - [ ] 实现错误响应格式

#### 验收标准

- [ ] 所有消息 API 接口正常工作
- [ ] 请求参数验证正常
- [ ] 错误处理正常
- [ ] API 文档可以正常访问

#### 测试验证

```bash
# 1. 发送消息
curl -X POST http://localhost:8000/api/message/send \
  -H "Content-Type: application/json" \
  -d '{
    "content": "测试消息",
    "session_id": "test_user"
  }'

# 2. 获取消息列表
curl "http://localhost:8000/api/message/list?session_id=test_user&page=1&page_size=20"

# 3. 获取单条消息
curl "http://localhost:8000/api/message/msg_xxx"
```

---

### 里程碑 4：Celery 异步任务（2-3 天）

**目标**：完成 Celery 配置和异步任务实现。

#### 任务清单

1. **Celery 配置**
   - [ ] 实现 `app/tasks/celery_app.py`
   - [ ] 配置 Redis 作为 Broker
   - [ ] 配置任务序列化

2. **AI 回复任务**
   - [ ] 实现 `app/tasks/ai_reply_task.py`
   - [ ] 实现消息触发 AI 回复逻辑
   - [ ] 实现任务错误处理

3. **任务集成**
   - [ ] 在消息服务中集成 Celery 任务
   - [ ] 实现任务状态跟踪

#### 验收标准

- [ ] Celery Worker 可以正常启动
- [ ] 任务可以正常提交和执行
- [ ] 任务错误处理正常

#### 测试验证

```bash
# 1. 启动 Celery Worker
celery -A app.tasks.celery_app worker --loglevel=info

# 2. 发送消息（会触发 AI 回复任务）
curl -X POST http://localhost:8000/api/message/send \
  -H "Content-Type: application/json" \
  -d '{
    "content": "你好",
    "session_id": "test_user"
  }'

# 3. 检查 Celery 日志
# 应该看到任务执行日志
```

---

### 里程碑 5：AI 服务集成（3-4 天）

**目标**：完成 LangChain 集成和 AI 回复功能。

#### 任务清单

1. **AI 服务层**
   - [ ] 实现 `app/services/ai_service.py`
   - [ ] 集成 LangChain
   - [ ] 实现 AI 回复逻辑
   - [ ] 实现流式回复（可选）

2. **AI 配置**
   - [ ] 配置 AI 服务提供商（OpenAI/DeepSeek 等）
   - [ ] 配置 AI 模型参数
   - [ ] 实现 AI 错误处理

3. **AI 聊天记录**
   - [ ] 完善 AI 聊天记录保存逻辑
   - [ ] 实现 AI 回复状态跟踪

#### 验收标准

- [ ] AI 服务可以正常调用
- [ ] AI 回复可以正常生成
- [ ] AI 聊天记录可以正常保存
- [ ] AI 错误处理正常

#### 测试验证

```python
# 测试 AI 服务
from app.services.ai_service import AIService

ai_service = AIService()
response = ai_service.reply("你好")
print(f"AI回复: {response}")

# 测试完整流程
# 1. 发送消息
# 2. 检查 Celery 任务执行
# 3. 检查 AI 聊天记录
# 4. 验证 AI 回复内容
```

---

### 里程碑 6：WebSocket 实时通信（3-4 天）

**目标**：完成 WebSocket 连接管理和实时消息推送。

#### 任务清单

1. **WebSocket 管理器**
   - [ ] 实现 `app/websocket/manager.py`
   - [ ] 实现连接管理
   - [ ] 实现消息推送

2. **WebSocket 处理器**
   - [ ] 实现 `app/websocket/handler.py`
   - [ ] 实现消息接收处理
   - [ ] 实现连接断开处理

3. **WebSocket 服务**
   - [ ] 实现 `app/services/websocket_service.py`
   - [ ] 集成到 AI 回复流程

4. **WebSocket 路由**
   - [ ] 在 `app/main.py` 中注册 WebSocket 路由
   - [ ] 实现连接认证（可选）

#### 验收标准

- [ ] WebSocket 连接可以正常建立
- [ ] 客户端可以发送消息
- [ ] 服务端可以推送消息
- [ ] 连接断开处理正常

#### 测试验证

```javascript
// 测试 WebSocket
const ws = new WebSocket('ws://localhost:8000/ws/test_user');

ws.onopen = () => {
  console.log('Connected');
  // 发送消息
  ws.send(JSON.stringify({
    type: 'send_message',
    content: '你好'
  }));
};

ws.onmessage = (event) => {
  const message = JSON.parse(event.data);
  console.log('Received:', message);
  
  if (message.type === 'ai_reply') {
    console.log('AI回复:', message.content);
  }
};
```

---

### 里程碑 7：AI 相关 API（1-2 天）

**目标**：完成 AI 相关的 HTTP API 接口。

#### 任务清单

1. **AI API 路由**
   - [ ] 实现 `app/api/ai.py`
   - [ ] 实现 `GET /api/ai/records` 接口
   - [ ] 实现分页查询

2. **API 文档**
   - [ ] 完善 API 文档注释
   - [ ] 验证 API 接口

#### 验收标准

- [ ] AI 相关 API 正常工作
- [ ] 分页查询正常
- [ ] API 文档完整

#### 测试验证

```bash
# 获取 AI 聊天记录
curl "http://localhost:8000/api/ai/records?session_id=test_user&page=1&page_size=20"
```

---

### 里程碑 8：测试和优化（3-4 天）

**目标**：完成单元测试、集成测试、压测和性能优化。

#### 任务清单

1. **单元测试**
   - [ ] 编写消息服务测试
   - [ ] 编写 AI 服务测试
   - [ ] 编写 Repository 测试

2. **集成测试**
   - [ ] 编写 API 集成测试
   - [ ] 编写 WebSocket 集成测试
   - [ ] 编写完整流程测试

3. **压测**
   - [ ] 编写 Locust 压测脚本
   - [ ] 执行压测
   - [ ] 分析压测结果

4. **性能优化**
   - [ ] 优化数据库查询
   - [ ] 优化 Celery 任务处理
   - [ ] 优化 WebSocket 连接管理

5. **文档完善**
   - [ ] 完善 API 文档
   - [ ] 完善 README
   - [ ] 完善部署文档

#### 验收标准

- [ ] 单元测试通过率 > 80%
- [ ] 集成测试通过
- [ ] 压测结果满足需求（100 并发用户）
- [ ] 性能指标达标

#### 测试验证

```bash
# 1. 运行单元测试
pytest tests/ -v

# 2. 运行集成测试
pytest tests/integration/ -v

# 3. 运行压测
locust -f tests/locustfile.py --host=http://localhost:8000
```

---

## 三、开发顺序建议

### 3.1 推荐开发顺序

```
里程碑 1 → 里程碑 2 → 里程碑 3 → 里程碑 4 → 里程碑 5 → 里程碑 6 → 里程碑 7 → 里程碑 8
```

### 3.2 并行开发建议

- **里程碑 2 和里程碑 3**：可以部分并行（Schema 和 Repository 可以先完成）
- **里程碑 5 和里程碑 6**：可以部分并行（AI 服务可以先完成，WebSocket 推送后集成）

---

## 四、每个里程碑的交付物

### 4.1 代码交付物

- 源代码文件
- 测试文件
- 配置文件
- 数据库迁移脚本

### 4.2 文档交付物

- 代码注释
- API 文档更新
- 测试报告
- 问题记录

### 4.3 测试交付物

- 单元测试结果
- 集成测试结果
- 压测报告（里程碑 8）

---

## 五、风险控制

### 5.1 技术风险

- **AI 服务调用失败**：实现重试机制和错误处理
- **WebSocket 连接不稳定**：实现心跳机制和自动重连
- **数据库性能问题**：优化查询，添加索引

### 5.2 进度风险

- **AI 服务集成复杂**：提前调研 LangChain 使用
- **WebSocket 实现复杂**：参考 FastAPI 官方文档
- **压测发现问题**：预留优化时间

---

## 六、开发环境准备

### 6.1 必需环境

- Python 3.10+
- PostgreSQL 14+ 或 MySQL 8.0+
- Redis 6.0+
- Git

### 6.2 开发工具

- IDE：VS Code / PyCharm
- 数据库管理工具：DBeaver / pgAdmin
- API 测试工具：Postman / curl
- 压测工具：Locust

---

## 七、验收标准总结

### 7.1 功能验收

- [ ] 用户可以发送消息
- [ ] AI 可以自动回复消息
- [ ] 消息可以正常存储和查询
- [ ] WebSocket 实时推送正常
- [ ] 所有 API 接口正常工作

### 7.2 性能验收

- [ ] 支持 100 并发用户
- [ ] API 响应时间 < 200ms
- [ ] AI 回复时间 < 30s
- [ ] 消息不丢失

### 7.3 质量验收

- [ ] 代码注释完整
- [ ] API 文档完整
- [ ] 测试覆盖率 > 80%
- [ ] 无严重 Bug

---

**文档版本**：v1.0  
**创建时间**：2025-01-27  
**最后更新**：2025-01-27

