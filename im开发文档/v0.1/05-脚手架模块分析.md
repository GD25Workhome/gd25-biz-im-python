# Python 脚手架模块分析

## 一、Python 脚手架概述

### 1.1 什么是脚手架？

**脚手架（Scaffold/Boilerplate）** 是一个预定义的项目模板，包含：
- 标准化的项目结构
- 通用的基础设施代码
- 最佳实践和约定
- 可复用的工具类

使用脚手架可以：
- ✅ **快速启动新项目**：避免重复搭建基础框架
- ✅ **统一代码风格**：团队使用相同的项目结构
- ✅ **减少重复工作**：基础设施代码一次编写，多次使用
- ✅ **提高开发效率**：专注于业务逻辑，而不是基础设施

### 1.2 Python 脚手架工具

#### 1.2.1 CookieCutter（推荐）
```bash
# 安装
pip install cookiecutter

# 使用模板创建项目
cookiecutter https://github.com/audreyr/cookiecutter-pypackage
```

#### 1.2.2 FastAPI 官方模板
```bash
# FastAPI 项目生成器
fastapi new myproject
```

#### 1.2.3 自定义脚手架
- 创建自己的模板仓库
- 使用 Git 模板或脚本生成项目结构

---

## 二、本项目可放入脚手架的模块分析

### 2.1 ✅ **强烈推荐放入脚手架**（通用基础设施）

这些模块在大多数 FastAPI 项目中都会用到，应该放入脚手架：

#### 2.1.1 配置管理模块 (`app/config.py`)
**原因**：所有项目都需要配置管理
```python
# 通用功能：
- 环境变量管理
- 配置验证（Pydantic Settings）
- 多环境支持（开发/测试/生产）
```

**建议**：放入脚手架，但保留扩展点，允许项目添加自定义配置项。

#### 2.1.2 数据库基础模块 (`app/db/`)
**原因**：几乎所有项目都需要数据库
```python
# 通用功能：
- 数据库连接管理 (database.py)
- 基础模型类 (base.py) - 包含 id, created_at, updated_at
- 数据库会话管理 (session.py)
- get_db() 依赖注入函数
```

**建议**：放入脚手架，作为标准数据库配置。

#### 2.1.3 日志工具 (`app/utils/logger.py`)
**原因**：所有项目都需要日志
```python
# 通用功能：
- JSON 格式日志
- 日志级别配置
- 日志格式化
```

**建议**：放入脚手架，作为标准日志配置。

#### 2.1.4 ID 生成器 (`app/utils/id_generator.py`)
**原因**：很多项目需要生成唯一ID
```python
# 通用功能：
- 消息ID生成
- 记录ID生成
- 可扩展的ID生成策略
```

**建议**：放入脚手架，提供常用的ID生成方法。

#### 2.1.5 依赖注入 (`app/dependencies.py`)
**原因**：FastAPI 项目常用模式
```python
# 通用功能：
- 数据库依赖
- 认证依赖（可扩展）
- 权限检查依赖（可扩展）
```

**建议**：放入脚手架，提供基础依赖注入模式。

#### 2.1.6 主应用入口 (`app/main.py` 基础部分)
**原因**：FastAPI 应用的基础配置
```python
# 通用功能：
- FastAPI 应用初始化
- CORS 配置
- 中间件配置
- 健康检查接口 (/health)
- 启动/关闭事件处理
```

**建议**：放入脚手架，提供基础应用结构。

---

### 2.2 ⚠️ **可选放入脚手架**（根据项目类型决定）

这些模块在某些类型的项目中常用，但不是所有项目都需要：

#### 2.2.1 Celery 任务模块 (`app/tasks/celery_app.py`)
**原因**：只有需要异步任务的项目才需要
```python
# 适用场景：
- 需要异步任务处理
- 需要任务队列
- 需要定时任务
```

**建议**：作为可选模块，通过脚手架参数决定是否包含。

#### 2.2.2 WebSocket 基础模块 (`app/websocket/manager.py`)
**原因**：只有需要实时通信的项目才需要
```python
# 适用场景：
- 需要实时推送
- 需要双向通信
- IM、聊天、通知等场景
```

**建议**：作为可选模块，通过脚手架参数决定是否包含。

#### 2.2.3 Repository 基础类 (`app/repositories/base.py`)
**原因**：如果使用 Repository 模式，可以提取基础类
```python
# 通用功能：
- 基础 CRUD 操作
- 分页查询
- 通用查询方法
```

**建议**：如果团队统一使用 Repository 模式，可以放入脚手架。

---

### 2.3 ❌ **不建议放入脚手架**（业务相关）

这些模块是业务相关的，不应该放入脚手架：

#### 2.3.1 业务模型 (`app/models/message.py`, `app/models/ai_chat_record.py`)
**原因**：每个项目的业务模型都不同

#### 2.3.2 业务服务 (`app/services/message_service.py`, `app/services/ai_service.py`)
**原因**：业务逻辑是项目特定的

#### 2.3.3 业务 API (`app/api/message.py`, `app/api/ai.py`)
**原因**：API 接口是业务相关的

#### 2.3.4 Schema (`app/schemas/message.py`, `app/schemas/ai.py`)
**原因**：数据验证模型是业务相关的

---

## 三、推荐的脚手架结构

### 3.1 基础脚手架结构

```
fastapi-scaffold/
├── app/
│   ├── __init__.py
│   ├── main.py                    # FastAPI 应用入口（基础版）
│   ├── config.py                  # 配置管理 ⭐
│   ├── dependencies.py            # 依赖注入 ⭐
│   │
│   ├── db/                        # 数据库模块 ⭐
│   │   ├── __init__.py
│   │   ├── database.py           # 数据库连接
│   │   ├── base.py               # 基础模型
│   │   └── session.py            # 会话管理
│   │
│   ├── utils/                     # 工具类 ⭐
│   │   ├── __init__.py
│   │   ├── logger.py             # 日志工具
│   │   └── id_generator.py       # ID 生成器
│   │
│   ├── api/                       # API 路由（空结构）
│   │   └── __init__.py
│   │
│   ├── services/                  # 服务层（空结构）
│   │   └── __init__.py
│   │
│   ├── models/                    # 数据模型（空结构）
│   │   └── __init__.py
│   │
│   ├── schemas/                   # Schema（空结构）
│   │   └── __init__.py
│   │
│   └── repositories/              # 仓储层（可选）
│       ├── __init__.py
│       └── base.py               # 基础 Repository 类（可选）
│
├── alembic/                       # 数据库迁移 ⭐
│   ├── versions/
│   └── env.py
│
├── tests/                         # 测试目录 ⭐
│   ├── __init__.py
│   └── conftest.py               # pytest 配置
│
├── requirements.txt              # 依赖文件 ⭐
├── requirements-dev.txt           # 开发依赖 ⭐
├── .env.example                   # 环境变量示例 ⭐
├── .gitignore                     # Git 忽略文件 ⭐
├── alembic.ini                    # Alembic 配置 ⭐
├── pytest.ini                     # pytest 配置 ⭐
└── README.md                      # 项目说明 ⭐
```

### 3.2 可选模块（通过参数控制）

```
fastapi-scaffold/
├── app/
│   ├── tasks/                     # Celery 任务（可选）
│   │   ├── __init__.py
│   │   └── celery_app.py
│   │
│   └── websocket/                 # WebSocket（可选）
│       ├── __init__.py
│       └── manager.py
```

---

## 四、脚手架使用建议

### 4.1 创建脚手架的方式

#### 方式一：使用 CookieCutter 模板
```bash
# 1. 创建模板仓库
git clone https://github.com/your-org/fastapi-scaffold-template

# 2. 使用模板创建项目
cookiecutter fastapi-scaffold-template
```

#### 方式二：使用脚本生成
```bash
# 创建 generate_project.py 脚本
python generate_project.py --project-name myproject --include-celery --include-websocket
```

#### 方式三：使用 Git 模板
```bash
# 1. 创建模板仓库
git clone https://github.com/your-org/fastapi-scaffold-template myproject

# 2. 删除 .git，重新初始化
cd myproject
rm -rf .git
git init
```

### 4.2 脚手架配置参数

建议脚手架支持以下参数：

```yaml
project_name: "my-project"           # 项目名称
database: "postgresql"                # 数据库类型：postgresql/mysql
include_celery: true                 # 是否包含 Celery
include_websocket: false             # 是否包含 WebSocket
include_redis: true                  # 是否包含 Redis
log_format: "json"                   # 日志格式：json/text
```

---

## 五、具体实施建议

### 5.1 第一阶段：提取基础模块

**目标**：将通用基础设施代码提取到脚手架

**步骤**：
1. 创建脚手架仓库 `fastapi-scaffold`
2. 提取以下模块：
   - `app/config.py` - 配置管理
   - `app/db/` - 数据库基础模块
   - `app/utils/logger.py` - 日志工具
   - `app/utils/id_generator.py` - ID 生成器
   - `app/dependencies.py` - 依赖注入
   - `app/main.py` - 基础应用入口
   - `alembic/` - 数据库迁移配置
   - `requirements.txt` - 基础依赖
   - `.env.example` - 环境变量示例

### 5.2 第二阶段：添加可选模块

**目标**：将可选功能模块化

**步骤**：
1. 添加 Celery 模块（可选）
2. 添加 WebSocket 模块（可选）
3. 添加 Repository 基础类（可选）
4. 添加认证模块（可选）

### 5.3 第三阶段：完善脚手架工具

**目标**：提供便捷的项目生成工具

**步骤**：
1. 创建 CookieCutter 模板
2. 或创建 Python 脚本生成项目
3. 添加文档和示例

---

## 六、脚手架 vs 业务代码对比

### 6.1 脚手架应该包含的

| 模块 | 说明 | 是否放入脚手架 |
|------|------|----------------|
| 配置管理 | 环境变量、配置验证 | ✅ 是 |
| 数据库连接 | SQLAlchemy 配置 | ✅ 是 |
| 基础模型 | BaseModel（id, created_at, updated_at） | ✅ 是 |
| 日志工具 | 日志配置和格式化 | ✅ 是 |
| ID 生成器 | 通用ID生成方法 | ✅ 是 |
| 依赖注入 | 基础依赖注入模式 | ✅ 是 |
| 健康检查 | `/health` 接口 | ✅ 是 |
| CORS 配置 | 跨域配置 | ✅ 是 |
| Alembic 配置 | 数据库迁移配置 | ✅ 是 |
| Celery 基础 | Celery 应用配置（可选） | ⚠️ 可选 |
| WebSocket 基础 | WebSocket 管理器（可选） | ⚠️ 可选 |

### 6.2 业务代码应该保留的

| 模块 | 说明 | 是否放入脚手架 |
|------|------|----------------|
| 业务模型 | Message, AIChatRecord 等 | ❌ 否 |
| 业务服务 | MessageService, AIService 等 | ❌ 否 |
| 业务 API | 具体的 API 接口 | ❌ 否 |
| 业务 Schema | 业务相关的 Pydantic 模型 | ❌ 否 |
| 业务 Repository | 业务相关的数据访问 | ❌ 否 |

---

## 七、总结

### 7.1 核心原则

1. **基础设施 → 脚手架**：通用的、可复用的基础设施代码放入脚手架
2. **业务逻辑 → 项目**：业务相关的代码保留在具体项目中
3. **可选功能 → 参数化**：通过参数控制是否包含可选模块

### 7.2 推荐做法

1. **先提取基础模块**：配置、数据库、日志等通用模块
2. **再添加可选模块**：Celery、WebSocket 等根据项目需要
3. **保持脚手架简洁**：不要过度设计，保持灵活性

### 7.3 预期收益

- ✅ **开发效率提升 50%+**：新项目启动时间从 2-3 天减少到半天
- ✅ **代码质量统一**：团队使用相同的代码结构和最佳实践
- ✅ **减少重复工作**：基础设施代码一次编写，多次使用
- ✅ **降低维护成本**：统一的基础设施，便于统一维护和升级

---

**文档版本**：v1.0  
**创建时间**：2025-01-27  
**最后更新**：2025-01-27

