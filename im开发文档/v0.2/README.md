# IM 服务 - 开发文档（v0.2）

## 📚 文档索引

本文档空间包含 IM 服务的完整开发文档（v0.2版本），采用**核心+封装层**的架构设计，实现IM核心与AI服务的完全解耦。

### 文档列表

1. **[01-项目总体设计.md](./01-项目总体设计.md)**
   - 项目概述
   - 系统架构设计（核心+封装层）
   - 模块划分
   - 数据库设计
   - 技术选型

2. **[02-模块详细设计.md](./02-模块详细设计.md)**
   - 项目结构
   - 各模块详细设计
   - 代码示例
   - 实现要点

3. **[03-API接口文档.md](./03-API接口文档.md)**
   - HTTP API 接口
   - WebSocket API 接口
   - 请求/响应格式
   - 错误码说明
   - 调用示例

4. **[04-开发计划.md](./04-开发计划.md)**
   - 里程碑划分
   - 任务清单
   - 验收标准
   - 测试验证
   - 开发顺序

---

## 🎯 项目概述

### 核心功能

**IM核心层**：
- ✅ 用户发送消息（WebSocket + HTTP API）
- ✅ 消息存储和查询
- ✅ 群组管理（创建、加入、退出）
- ✅ 群组消息收发
- ✅ 实时消息推送（WebSocket）
- ✅ 用户身份标签管理（患者、医生、医生AI助手）

**AI封装层**（可选扩展）：
- ✅ 用户身份识别（患者/医生/医生AI助手）
- ✅ 消息路由规则（根据身份决定是否转发AI）
- ✅ 与外部AI服务通信（HTTP API）
- ✅ AI回复消息处理

### 技术栈

```
Python + FastAPI + SQLAlchemy + PostgreSQL + Redis（可选）
```

**注意**：不直接依赖 LangChain 等AI框架，通过HTTP API与外部AI服务通信。

### 项目特点

- **核心与扩展分离**：IM核心专注于消息收发，AI功能作为可选扩展层
- **完全解耦**：AI服务通过HTTP API通信，不依赖IM服务
- **灵活扩展**：AI封装层可以独立开发和部署
- **群组支持**：支持群组功能，用户通过身份标签区分角色

---

## 🏗️ 架构设计理念

### 核心+封装层架构

```
┌─────────────────────────────────────┐
│  AI封装层（可选扩展）                │  ← 定制化AI交互逻辑
│  - AI交互服务                        │
│  - 用户身份识别                      │
│  - 消息路由规则                      │
└─────────────────────────────────────┘
              ↓ 调用
┌─────────────────────────────────────┐
│  IM核心层（核心功能）                │  ← 纯消息收发
│  - 消息收发                          │
│  - 消息存储                          │
│  - 群组管理                          │
│  - WebSocket通信                     │
└─────────────────────────────────────┘
```

### 设计原则

1. **IM核心不依赖AI**：IM核心功能可以独立运行，不依赖AI服务
2. **AI封装层可选**：AI功能作为扩展层，可以独立开发和部署
3. **通过接口通信**：AI封装层通过HTTP API与外部AI服务通信
4. **完全解耦**：AI服务的变更不影响IM核心功能

---

## 🔄 核心业务流程

### 普通用户（患者）发送消息

```
1. 患者发送消息
   ↓
2. AI封装层识别身份（患者）
   ↓
3. AI封装层判断需要转发给AI服务
   ↓
4. IM核心保存消息
   ↓
5. AI封装层调用外部AI服务（HTTP API）
   ↓
6. AI服务返回回复
   ↓
7. AI封装层创建AI助手消息
   ↓
8. IM核心保存并推送AI回复
```

### 医生发送消息

```
1. 医生发送消息
   ↓
2. AI封装层识别身份（医生）
   ↓
3. AI封装层判断不需要转发给AI服务
   ↓
4. IM核心保存消息
   ↓
5. IM核心推送消息给群组所有成员
```

---

## 📖 文档使用指南

### 对于开发者

1. **开始开发前**：阅读 `01-项目总体设计.md` 了解整体架构
2. **开发具体模块**：参考 `02-模块详细设计.md` 了解实现细节
3. **开发 API**：参考 `03-API接口文档.md` 了解接口规范
4. **按计划开发**：参考 `04-开发计划.md` 按里程碑推进

### 对于前端开发者

1. **API 对接**：主要参考 `03-API接口文档.md`
2. **WebSocket 对接**：参考 `03-API接口文档.md` 中的 WebSocket 部分
3. **错误处理**：参考 `03-API接口文档.md` 中的错误码说明

---

## 🔄 开发流程

### 1. 理解需求

- 阅读 `01-项目总体设计.md` 了解项目背景和需求
- 阅读 `04-开发计划.md` 了解开发计划

### 2. 开始开发

- 按照 `04-开发计划.md` 中的里程碑顺序开发
- 参考 `02-模块详细设计.md` 实现具体模块
- 参考 `03-API接口文档.md` 实现 API 接口

### 3. 测试验证

- 每个里程碑完成后进行测试验证
- 参考 `04-开发计划.md` 中的测试验证部分

### 4. 文档更新

- 代码变更时同步更新文档
- API 变更时更新 `03-API接口文档.md`

---

## 📝 开发规范

### 代码规范

- 使用 Python 类型提示（Type Hints）
- 遵循 PEP 8 代码风格
- 使用 Pydantic 进行数据验证
- 添加必要的代码注释（简体中文）

### 文档规范

- 代码变更时同步更新文档
- API 变更时更新 API 文档
- 重要功能添加使用示例

### 测试规范

- 每个模块编写单元测试
- 关键流程编写集成测试
- 使用 Locust 进行压测

---

## 🆚 v0.2 与 v0.1 的主要区别

### v0.1（旧版本）

- ❌ AI服务直接集成在IM服务中
- ❌ IM核心依赖LangChain等AI框架
- ❌ AI服务与IM服务耦合
- ❌ 不支持群组功能
- ❌ 不支持用户身份标签

### v0.2（新版本）

- ✅ **核心与扩展分离**：IM核心专注于消息收发
- ✅ **AI封装层**：AI功能作为可选扩展层
- ✅ **完全解耦**：通过HTTP API与外部AI服务通信
- ✅ **群组支持**：支持群组功能
- ✅ **身份标签**：支持用户身份标签（患者、医生、医生AI助手）
- ✅ **智能路由**：根据用户身份决定是否转发AI

---

## 📅 开发进度

### 里程碑进度

- [ ] 里程碑 1：项目基础搭建
- [ ] 里程碑 2：IM核心 - 数据模型和仓储层
- [ ] 里程碑 3：IM核心 - 消息服务 API
- [ ] 里程碑 4：IM核心 - 群组服务 API
- [ ] 里程碑 5：IM核心 - WebSocket 实时通信
- [ ] 里程碑 6：AI封装层 - AI交互服务
- [ ] 里程碑 7：AI封装层 - 消息路由服务
- [ ] 里程碑 8：测试和优化

### 当前状态

- **项目状态**：设计阶段
- **当前里程碑**：未开始
- **预计完成时间**：3-4 周

---

## 🔗 相关文档

### 参考文档

- [FastAPI 官方文档](https://fastapi.tiangolo.com/)
- [SQLAlchemy 官方文档](https://docs.sqlalchemy.org/)
- [Celery 官方文档](https://docs.celeryproject.org/)

### 历史版本

- [v0.1 文档](../v0.1/) - 旧版本设计（AI服务集成在IM中）

---

## 📞 联系方式

如有问题或建议，请通过以下方式联系：

- 项目 Issue
- 文档更新 PR

---

**文档版本**：v0.2  
**创建时间**：2025-01-27  
**最后更新**：2025-01-27  
**更新说明**：重新设计，实现IM核心与AI服务的完全解耦
