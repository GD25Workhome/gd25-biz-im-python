# IM 服务 - 开发计划（v0.2）

## 一、开发计划概述

### 1.1 总体目标

开发一个轻量级 IM 服务，采用**核心+封装层**架构：
- **IM核心层**：专注于消息收发、群组管理、用户管理等核心功能
- **AI封装层**：可选的扩展层，通过HTTP API与外部AI服务通信

### 1.2 脚手架依赖说明

**重要**：本项目基于 `gd25-arch-backend-python` 脚手架开发。

#### 1.2.1 脚手架提供的模块

以下模块由脚手架提供，**无需重复开发**：

| 模块 | 说明 | 来源 |
|------|------|------|
| 配置管理 | `app/config.py` | 脚手架 |
| 数据库连接 | `app/db/database.py` | 脚手架 |
| 基础模型 | `app/db/base.py` | 脚手架 |
| 会话管理 | `app/db/session.py` | 脚手架 |
| 日志工具 | `app/utils/logger.py` | 脚手架 |
| ID 生成器 | `app/utils/id_generator.py` | 脚手架 |
| 依赖注入 | `app/dependencies.py` | 脚手架 |
| 主应用入口（基础） | `app/main.py`（基础部分） | 脚手架 |
| Alembic 配置 | `alembic/env.py` | 脚手架 |
| Celery 配置（可选） | `app/tasks/celery_app.py` | 脚手架（可选） |
| WebSocket 管理器（可选） | `app/websocket/manager.py` | 脚手架（可选） |

#### 1.2.2 本项目需要开发的模块

**IM核心模块**：

| 模块 | 说明 | 开发方式 |
|------|------|----------|
| 业务模型 | `app/models/user.py`, `app/models/group.py`, `app/models/group_member.py`, `app/models/message.py` | 新建 |
| 业务 Schema | `app/schemas/user.py`, `app/schemas/group.py`, `app/schemas/message.py` | 新建 |
| 业务 Repository | `app/repositories/user_repository.py`, `app/repositories/group_repository.py`, `app/repositories/group_member_repository.py`, `app/repositories/message_repository.py` | 新建 |
| 业务服务 | `app/services/core/user_service.py`, `app/services/core/group_service.py`, `app/services/core/message_service.py`, `app/services/core/websocket_service.py` | 新建 |
| 业务 API | `app/api/user.py`, `app/api/group.py`, `app/api/message.py` | 新建 |
| WebSocket 处理器 | `app/websocket/handler.py` | 新建 |

**AI封装层模块**：

| 模块 | 说明 | 开发方式 |
|------|------|----------|
| AI交互记录模型 | `app/models/ai_interaction_record.py` | 新建 |
| AI Schema | `app/schemas/ai.py` | 新建 |
| AI交互记录仓储 | `app/repositories/ai_interaction_repository.py` | 新建 |
| AI服务 | `app/services/ai/ai_interaction_service.py`, `app/services/ai/message_router_service.py` | 新建 |
| AI API | `app/api/ai.py` | 新建 |
| AI任务（可选） | `app/tasks/ai_interaction_task.py` | 新建（可选） |

### 1.3 开发原则

- **核心优先**：先开发IM核心功能，再开发AI封装层
- **模块化开发**：各模块相对独立，便于并行开发
- **文档驱动**：代码与文档同步更新
- **测试验证**：每个里程碑包含测试验证环节
- **复用脚手架**：充分利用脚手架提供的基础设施，避免重复开发

### 1.4 开发周期

预计总开发时间：**3-4 周**

**前提条件**：✅ 脚手架项目核心模块已完成，且已支持 CookieCutter 模板

---

## 二、里程碑划分

### 里程碑 1：项目基础搭建（1-2 天）

**目标**：基于脚手架完成项目初始化，配置项目特定设置，创建业务数据库表。

**前置条件**：✅ 脚手架项目核心模块已完成，且已支持 CookieCutter 模板

#### 任务清单

**任务 1.1：环境准备**

- [ ] 确认 conda 环境已创建：`conda activate py311_gb25_im`
- [ ] 验证 Python 版本：`python --version`（应为 3.10+）
- [ ] 验证 pip 可用：`pip list`

**验收标准**：
- Python 版本 >= 3.10
- pip 可以正常使用

---

**任务 1.2：项目初始化（使用 CookieCutter 模板）**

- [ ] 安装 CookieCutter：`pip install cookiecutter`
- [ ] 使用脚手架模板生成项目：
  ```bash
  cookiecutter /Users/m684620/work/github_GD25/gd25-arch-backend-python/cookiecutter-gd25-arch-backend-python
  ```
- [ ] 按提示输入项目信息：
  - `project_name`: `gd25-biz-im-python`
  - `include_celery`: `y`（可选，如果需要异步处理）
  - `include_websocket`: `y`（需要WebSocket）
  - `database_type`: `postgresql`
- [ ] 进入生成的项目目录：`cd gd25-biz-im-python`
- [ ] 检查项目结构是否完整

**验收标准**：
- 项目目录结构完整
- 包含 `app/`, `alembic/`, `tests/` 等目录
- 包含 `requirements.txt`, `.env.example` 等文件

---

**任务 1.3：配置扩展（基于脚手架配置）**

- [ ] 扩展 `app/config.py`，添加AI服务相关配置项：
  ```python
  # AI服务配置（AI封装层使用）
  ai_service_url: str = Field(..., description='外部AI服务URL')
  ai_service_api_key: str = Field(..., description='外部AI服务API密钥')
  ai_service_timeout: int = Field(default=30, description='AI服务请求超时时间（秒）')
  ```
- [ ] 更新 `.env.example`，添加AI服务配置示例：
  ```
  AI_SERVICE_URL=https://ai-service.example.com/api/chat
  AI_SERVICE_API_KEY=your_api_key_here
  AI_SERVICE_TIMEOUT=30
  ```
- [ ] 验证配置加载正常：创建测试脚本验证配置可以正常读取

**验收标准**：
- `app/config.py` 包含AI服务配置项
- `.env.example` 包含AI服务配置示例
- 配置可以正常加载（无报错）

---

**任务 1.4：数据库表创建（基于脚手架数据库模块）**

- [ ] 创建业务数据模型：
  - `app/models/user.py` - 用户模型
  - `app/models/group.py` - 群组模型
  - `app/models/group_member.py` - 群组成员模型
  - `app/models/message.py` - 消息模型
  - `app/models/ai_interaction_record.py` - AI交互记录模型
- [ ] 更新 `app/models/__init__.py`，导出所有模型：
  ```python
  from app.models.user import User
  from app.models.group import Group
  from app.models.group_member import GroupMember
  from app.models.message import Message
  from app.models.ai_interaction_record import AIInteractionRecord
  ```
- [ ] 更新 `alembic/env.py`，确保导入所有模型（脚手架已配置，只需确认）
- [ ] 创建数据库迁移脚本：
  ```bash
  alembic revision --autogenerate -m "Create initial tables"
  ```
- [ ] 检查生成的迁移脚本，确认包含所有表：
  - `users`
  - `groups`
  - `group_members`
  - `messages`
  - `ai_interaction_records`
- [ ] 执行数据库迁移：
  ```bash
  alembic upgrade head
  ```
- [ ] 验证数据库表创建成功（使用数据库工具检查）

**验收标准**：
- 所有模型文件已创建
- `app/models/__init__.py` 导出所有模型
- 数据库迁移脚本已创建
- 数据库表创建成功（5个表都存在）

---

**任务 1.5：主应用扩展（基于脚手架主应用）**

- [ ] 检查 `app/main.py`（脚手架提供的基础版本）
- [ ] 验证健康检查接口正常：
  ```bash
  curl http://localhost:8000/health
  ```
- [ ] 预留业务路由注册位置（后续里程碑实现）

**验收标准**：
- 项目可以正常启动：`uvicorn app.main:app --reload`
- 健康检查接口返回正常：`{"status": "ok"}`
- 日志输出正常（使用脚手架日志工具）

---

#### 验收标准总结

- [ ] 项目可以正常启动（基于脚手架）
- [ ] 数据库连接正常（使用脚手架模块）
- [ ] 健康检查接口返回正常（脚手架提供）
- [ ] 日志输出正常（使用脚手架日志工具）
- [ ] 数据库表创建成功（5个表：users, groups, group_members, messages, ai_interaction_records）
- [ ] 项目特定配置加载正常（AI服务配置）

---

#### 测试验证

```bash
# 1. 启动服务
cd gd25-biz-im-python
uvicorn app.main:app --reload

# 2. 测试健康检查
curl http://localhost:8000/health
# 预期响应：{"status": "ok"}

# 3. 检查日志输出
# 应该看到服务启动日志

# 4. 验证数据库表创建
# 使用数据库工具（如DBeaver）检查以下表是否存在：
# - users
# - groups
# - group_members
# - messages
# - ai_interaction_records

# 5. 访问 API 文档
# Swagger UI: http://localhost:8000/docs
# ReDoc: http://localhost:8000/redoc
```

---

### 里程碑 2：IM核心 - 数据模型和仓储层（2-3 天）

**目标**：完成IM核心的数据模型定义、Schema定义、Repository模式实现。

**前置条件**：✅ 里程碑1已完成

#### 任务清单

**任务 2.1：数据模型实现**

- [ ] 实现 `app/models/user.py`：
  - 字段：`user_id`, `username`, `user_role`
  - 索引：`idx_user_id`, `idx_user_role`
  - 方法：`is_patient()`, `is_doctor()`, `is_ai_assistant()`
- [ ] 实现 `app/models/group.py`：
  - 字段：`group_id`, `group_name`, `description`, `created_by`
  - 索引：`idx_group_id`, `idx_created_by`
- [ ] 实现 `app/models/group_member.py`：
  - 字段：`group_id`, `user_id`, `user_role`, `joined_at`
  - 联合唯一约束：`uk_group_user`
  - 索引：`idx_group_id`, `idx_user_id`, `idx_user_role`
- [ ] 实现 `app/models/message.py`：
  - 字段：`message_id`, `group_id`, `from_user_id`, `msg_type`, `msg_content`
  - 索引：`idx_group_id`, `idx_from_user_id`, `idx_created_at`, `idx_group_created`
- [ ] 验证所有模型继承自 `BaseModel`（脚手架提供）

**验收标准**：
- 所有模型文件已实现
- 所有字段、索引、约束正确定义
- 模型可以正常导入

---

**任务 2.2：Schema定义**

- [ ] 实现 `app/schemas/user.py`：
  - `UserCreate`: `username`, `user_role`（Literal类型）
  - `UserUpdate`: `username`（可选）, `user_role`（可选）
  - `UserResponse`: 所有字段
- [ ] 实现 `app/schemas/group.py`：
  - `GroupCreate`: `group_name`, `description`（可选）
  - `GroupResponse`: 所有字段
  - `GroupMemberAdd`: `user_id`, `user_role`（Literal类型）
- [ ] 实现 `app/schemas/message.py`：
  - `MessageCreate`: `group_id`, `content`
  - `MessageResponse`: 所有字段
  - `MessageListResponse`: `messages`, `total`, `page`, `page_size`
- [ ] 验证所有Schema使用Pydantic类型验证

**验收标准**：
- 所有Schema文件已实现
- 所有字段验证规则正确定义
- Schema可以正常导入和使用

---

**任务 2.3：Repository层实现**

- [ ] 实现 `app/repositories/user_repository.py`：
  - `create(user_id, username, user_role) -> User`
  - `get_by_id(user_id) -> Optional[User]`
  - `update(user) -> User`
- [ ] 实现 `app/repositories/group_repository.py`：
  - `create(group_id, group_name, description, created_by) -> Group`
  - `get_by_id(group_id) -> Optional[Group]`
  - `update(group) -> Group`
- [ ] 实现 `app/repositories/group_member_repository.py`：
  - `add_member(group_id, user_id, user_role) -> GroupMember`
  - `get_member(group_id, user_id) -> Optional[GroupMember]`
  - `get_members_by_group(group_id) -> List[GroupMember]`
  - `remove_member(group_id, user_id) -> bool`
- [ ] 实现 `app/repositories/message_repository.py`：
  - `create(message_id, group_id, from_user_id, msg_type, msg_content) -> Message`
  - `get_by_id(message_id) -> Optional[Message]`
  - `get_by_group(group_id, page, page_size) -> Tuple[List[Message], int]`
- [ ] 验证所有Repository使用脚手架提供的ID生成器

**验收标准**：
- 所有Repository文件已实现
- 所有方法正确定义
- Repository可以正常进行CRUD操作

---

#### 验收标准总结

- [ ] 数据库表创建成功（5个表）
- [ ] Repository可以正常进行CRUD操作
- [ ] Schema验证正常
- [ ] 所有模型、Schema、Repository可以正常导入

---

#### 测试验证

```python
# 测试 Repository
from app.db.database import SessionLocal
from app.repositories.user_repository import UserRepository
from app.repositories.group_repository import GroupRepository
from app.repositories.message_repository import MessageRepository
from app.utils.id_generator import generate_user_id, generate_group_id, generate_message_id

db = SessionLocal()

# 测试用户Repository
user_repo = UserRepository(db)
user_id = generate_user_id()
user = user_repo.create(user_id, "测试用户", "PATIENT")
print(f"Created user: {user.user_id}")

# 测试群组Repository
group_repo = GroupRepository(db)
group_id = generate_group_id()
group = group_repo.create(group_id, "测试群组", "测试描述", user_id)
print(f"Created group: {group.group_id}")

# 测试消息Repository
message_repo = MessageRepository(db)
message_id = generate_message_id()
message = message_repo.create(message_id, group_id, user_id, "TEXT", "测试消息")
print(f"Created message: {message.message_id}")

db.close()
```

---

### 里程碑 3：IM核心 - 用户和群组服务 API（2-3 天）

**目标**：完成用户服务和群组服务的HTTP API接口。

**前置条件**：✅ 里程碑2已完成

#### 任务清单

**任务 3.1：用户服务层实现**

- [ ] 实现 `app/services/core/user_service.py`：
  - `create_user(user_create: UserCreate) -> UserResponse`
  - `get_user(user_id: str) -> Optional[UserResponse]`
  - `update_user_role(user_id: str, new_role: str) -> UserResponse`
- [ ] 验证用户身份验证逻辑（PATIENT/DOCTOR/AI_ASSISTANT）
- [ ] 验证错误处理（用户不存在、无效user_role等）

**验收标准**：
- 用户服务所有方法已实现
- 用户身份验证逻辑正确
- 错误处理完善

---

**任务 3.2：群组服务层实现**

- [ ] 实现 `app/services/core/group_service.py`：
  - `create_group(group_create: GroupCreate, creator_id: str) -> GroupResponse`
  - `get_group(group_id: str) -> Optional[GroupResponse]`
  - `add_member(group_id: str, member_add: GroupMemberAdd) -> bool`
  - `get_group_members(group_id: str) -> List[dict]`
- [ ] 验证创建群组时自动添加创建人为成员（身份为DOCTOR）
- [ ] 验证添加成员时的错误处理（群组不存在、用户已在群组中等）

**验收标准**：
- 群组服务所有方法已实现
- 创建群组时自动添加创建人为成员
- 错误处理完善

---

**任务 3.3：用户API路由实现**

- [ ] 实现 `app/api/user.py`：
  - `POST /api/user/create` - 创建用户
  - `GET /api/user/{user_id}` - 获取用户信息
  - `PUT /api/user/{user_id}/role` - 更新用户身份标签
- [ ] 在 `app/main.py` 中注册用户路由：
  ```python
  from app.api import user
  app.include_router(user.router, prefix="/api")
  ```
- [ ] 验证请求参数验证（使用Pydantic Schema）
- [ ] 验证错误响应格式统一

**验收标准**：
- 所有用户API接口已实现
- 路由已注册
- 请求参数验证正常
- 错误响应格式统一

---

**任务 3.4：群组API路由实现**

- [ ] 实现 `app/api/group.py`：
  - `POST /api/group/create` - 创建群组
  - `GET /api/group/{group_id}` - 获取群组信息
  - `POST /api/group/{group_id}/members` - 添加群组成员
  - `GET /api/group/{group_id}/members` - 获取群组成员列表
- [ ] 在 `app/main.py` 中注册群组路由：
  ```python
  from app.api import group
  app.include_router(group.router, prefix="/api")
  ```
- [ ] 验证请求参数验证
- [ ] 验证错误响应格式统一

**验收标准**：
- 所有群组API接口已实现
- 路由已注册
- 请求参数验证正常
- 错误响应格式统一

---

#### 验收标准总结

- [ ] 所有用户和群组API接口正常工作
- [ ] 请求参数验证正常
- [ ] 错误处理正常
- [ ] API文档可以正常访问（Swagger UI）

---

#### 测试验证

```bash
# 1. 创建用户
curl -X POST http://localhost:8000/api/user/create \
  -H "Content-Type: application/json" \
  -d '{
    "username": "测试用户",
    "user_role": "PATIENT"
  }'

# 2. 获取用户信息
curl "http://localhost:8000/api/user/user_xxx"

# 3. 创建群组
curl -X POST http://localhost:8000/api/group/create \
  -H "Content-Type: application/json" \
  -d '{
    "group_name": "测试群组",
    "description": "测试描述"
  }'

# 4. 添加群组成员
curl -X POST http://localhost:8000/api/group/group_xxx/members \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "user_xxx",
    "user_role": "PATIENT"
  }'

# 5. 获取群组成员列表
curl "http://localhost:8000/api/group/group_xxx/members"

# 6. 访问 API 文档
# Swagger UI: http://localhost:8000/docs
```

---

### 里程碑 4：IM核心 - 消息服务 API（2-3 天）

**目标**：完成消息服务的HTTP API接口。

**前置条件**：✅ 里程碑3已完成

#### 任务清单

**任务 4.1：消息服务层实现**

- [ ] 实现 `app/services/core/message_service.py`：
  - `send_message(message_create: MessageCreate, from_user_id: str) -> MessageResponse`
  - `get_message(message_id: str) -> MessageResponse`
  - `get_messages(group_id: str, page: int, page_size: int) -> Tuple[List[MessageResponse], int]`
- [ ] 验证发送消息时的错误处理（群组不存在、发送人不在群组中等）
- [ ] 验证分页参数验证（page >= 1, page_size 1-100）

**验收标准**：
- 消息服务所有方法已实现
- 错误处理完善
- 分页功能正常

---

**任务 4.2：消息API路由实现**

- [ ] 实现 `app/api/message.py`：
  - `POST /api/message/send` - 发送消息
  - `GET /api/message/{message_id}` - 获取单条消息
  - `GET /api/message/list` - 获取消息列表（支持分页）
- [ ] 在 `app/main.py` 中注册消息路由：
  ```python
  from app.api import message
  app.include_router(message.router, prefix="/api")
  ```
- [ ] 验证请求参数验证
- [ ] 验证分页功能正常

**验收标准**：
- 所有消息API接口已实现
- 路由已注册
- 请求参数验证正常
- 分页功能正常

---

#### 验收标准总结

- [ ] 所有消息API接口正常工作
- [ ] 请求参数验证正常
- [ ] 错误处理正常
- [ ] 分页功能正常

---

#### 测试验证

```bash
# 1. 发送消息
curl -X POST http://localhost:8000/api/message/send \
  -H "Content-Type: application/json" \
  -d '{
    "group_id": "group_xxx",
    "content": "测试消息"
  }'

# 2. 获取消息列表
curl "http://localhost:8000/api/message/list?group_id=group_xxx&page=1&page_size=20"

# 3. 获取单条消息
curl "http://localhost:8000/api/message/msg_xxx"
```

---

### 里程碑 5：IM核心 - WebSocket 实时通信（2-3 天）

**目标**：完成WebSocket实时消息推送功能。

**前置条件**：✅ 里程碑4已完成，✅ 脚手架WebSocket管理器可用

#### 任务清单

**任务 5.1：WebSocket服务层实现**

- [ ] 实现 `app/services/core/websocket_service.py`：
  - `send_message_to_group(group_id: str, message: dict, exclude_user_id: Optional[str] = None) -> int`
  - `send_message_to_user(user_id: str, message: dict) -> bool`
- [ ] 验证使用脚手架提供的WebSocket管理器（`app/websocket/manager.py`）
- [ ] 验证消息推送格式统一

**验收标准**：
- WebSocket服务所有方法已实现
- 使用脚手架提供的管理器
- 消息推送格式统一

---

**任务 5.2：WebSocket处理器实现**

- [ ] 实现 `app/websocket/handler.py`：
  - `handle_connection(websocket: WebSocket, user_id: str)`
  - `handle_send_message(user_id: str, group_id: str, content: str)`
- [ ] 验证WebSocket连接管理
- [ ] 验证消息接收和处理逻辑
- [ ] 验证连接断开处理

**验收标准**：
- WebSocket处理器已实现
- 连接管理正常
- 消息接收和处理正常

---

**任务 5.3：WebSocket路由注册**

- [ ] 在 `app/main.py` 中注册WebSocket路由：
  ```python
  @app.websocket("/ws/{user_id}")
  async def websocket_endpoint(websocket: WebSocket, user_id: str):
      # 调用handler处理连接
  ```
- [ ] 验证WebSocket连接可以正常建立
- [ ] 验证消息可以正常推送

**验收标准**：
- WebSocket路由已注册
- 连接可以正常建立
- 消息可以正常推送

---

#### 验收标准总结

- [ ] WebSocket连接可以正常建立
- [ ] 客户端可以发送消息
- [ ] 服务端可以推送消息
- [ ] 连接断开处理正常

---

#### 测试验证

```javascript
// 测试 WebSocket
const ws = new WebSocket('ws://localhost:8000/ws/user_xxx');

ws.onopen = () => {
  console.log('Connected');
  // 发送消息
  ws.send(JSON.stringify({
    type: 'send_message',
    group_id: 'group_xxx',
    content: '测试消息'
  }));
};

ws.onmessage = (event) => {
  const message = JSON.parse(event.data);
  console.log('Received:', message);
};
```

---

### 里程碑 6：AI封装层 - AI交互服务（2-3 天）

**目标**：完成AI交互服务，实现与外部AI服务的HTTP通信。

**前置条件**：✅ 里程碑5已完成

#### 任务清单

**任务 6.1：AI交互记录仓储实现**

- [ ] 实现 `app/repositories/ai_interaction_repository.py`：
  - `create(record_id, group_id, user_message_id, ai_service_url, request_content, status) -> AIInteractionRecord`
  - `update_success(record_id, ai_message_id, response_content, duration_ms) -> AIInteractionRecord`
  - `update_failed(record_id, error_message) -> AIInteractionRecord`
  - `get_by_group(group_id, page, page_size) -> Tuple[List[AIInteractionRecord], int]`
- [ ] 验证AI交互记录CRUD操作正常

**验收标准**：
- AI交互记录仓储已实现
- CRUD操作正常

---

**任务 6.2：AI交互服务实现**

- [ ] 实现 `app/services/ai/ai_interaction_service.py`：
  - `process_ai_request(group_id, user_message_id, user_message_content, conversation_history) -> Optional[str]`
  - `_call_ai_service(user_message, conversation_history) -> str`（私有方法）
- [ ] 验证使用httpx进行HTTP请求
- [ ] 验证AI服务URL和API密钥从配置读取
- [ ] 验证AI服务请求格式正确：
  ```json
  {
    "message": "用户消息",
    "history": [{"role": "user", "content": "..."}, ...]
  }
  ```
- [ ] 验证AI服务响应格式解析：
  ```json
  {
    "reply": "AI回复内容"
  }
  ```
- [ ] 验证错误处理（HTTP错误、超时、响应格式错误等）

**验收标准**：
- AI交互服务已实现
- HTTP请求正常
- 错误处理完善

---

**任务 6.3：消息路由服务实现**

- [ ] 实现 `app/services/ai/message_router_service.py`：
  - `should_route_to_ai(group_id: str, user_id: str) -> bool`
  - `get_user_role_in_group(group_id: str, user_id: str) -> Optional[str]`
- [ ] 验证路由规则：只有`PATIENT`身份的消息需要转发给AI
- [ ] 验证基于群组身份标签（`group_members.user_role`）判断，而不是系统身份

**验收标准**：
- 消息路由服务已实现
- 路由规则正确
- 基于群组身份标签判断

---

**任务 6.4：消息服务集成AI交互**

- [ ] 修改 `app/services/core/message_service.py`，在发送消息后：
  - 调用 `MessageRouterService.should_route_to_ai()` 判断是否需要转发AI
  - 如果需要，调用 `AIInteractionService.process_ai_request()` 异步处理
- [ ] 验证患者消息会自动转发给AI服务
- [ ] 验证医生消息不会转发给AI服务
- [ ] 验证AI回复会通过WebSocket推送

**验收标准**：
- 消息服务已集成AI交互
- 患者消息自动转发AI
- 医生消息不转发AI
- AI回复通过WebSocket推送

---

**任务 6.5：AI API路由实现（可选）**

- [ ] 实现 `app/api/ai.py`：
  - `GET /api/ai/interactions` - 获取AI交互记录
- [ ] 在 `app/main.py` 中注册AI路由（可选）

**验收标准**：
- AI API接口已实现（可选）
- 路由已注册（可选）

---

#### 验收标准总结

- [ ] AI交互服务可以正常调用外部AI服务
- [ ] 消息路由规则正确（患者转发AI，医生不转发）
- [ ] AI回复可以正常创建和推送
- [ ] AI交互记录可以正常保存

---

#### 测试验证

```bash
# 1. 配置AI服务URL和API密钥（在.env文件中）
AI_SERVICE_URL=https://ai-service.example.com/api/chat
AI_SERVICE_API_KEY=your_api_key_here

# 2. 创建患者用户并加入群组
# 3. 患者发送消息（应该自动转发给AI）
curl -X POST http://localhost:8000/api/message/send \
  -H "Content-Type: application/json" \
  -d '{
    "group_id": "group_xxx",
    "content": "你好"
  }'

# 4. 检查AI交互记录
curl "http://localhost:8000/api/ai/interactions?group_id=group_xxx"

# 5. 通过WebSocket接收AI回复
# （使用WebSocket客户端测试）
```

---

### 里程碑 7：测试和优化（3-4 天）

**目标**：完成单元测试、集成测试、压测和性能优化。

**前置条件**：✅ 里程碑6已完成

#### 任务清单

**任务 7.1：单元测试**

- [ ] 编写用户服务测试：`tests/test_user_service.py`
- [ ] 编写群组服务测试：`tests/test_group_service.py`
- [ ] 编写消息服务测试：`tests/test_message_service.py`
- [ ] 编写AI交互服务测试：`tests/test_ai_interaction_service.py`
- [ ] 运行所有单元测试：`pytest tests/ -v`

**验收标准**：
- 单元测试通过率 > 80%
- 关键功能都有测试覆盖

---

**任务 7.2：集成测试**

- [ ] 编写API集成测试：`tests/test_api_integration.py`
- [ ] 编写WebSocket集成测试：`tests/test_websocket_integration.py`
- [ ] 编写完整流程测试（用户创建 → 群组创建 → 消息发送 → AI回复）
- [ ] 运行所有集成测试：`pytest tests/integration/ -v`

**验收标准**：
- 集成测试通过
- 完整流程测试通过

---

**任务 7.3：压测**

- [ ] 编写Locust压测脚本：`tests/locustfile.py`
- [ ] 执行压测：
  ```bash
  locust -f tests/locustfile.py --host=http://localhost:8000
  ```
- [ ] 分析压测结果
- [ ] 优化性能瓶颈

**验收标准**：
- 压测结果满足需求（100并发用户）
- 性能指标达标

---

**任务 7.4：性能优化**

- [ ] 优化数据库查询（添加索引、优化SQL）
- [ ] 优化WebSocket连接管理
- [ ] 优化AI服务调用（异步处理、连接池等）

**验收标准**：
- 性能指标达标
- 响应时间 < 200ms

---

**任务 7.5：文档完善**

- [ ] 完善API文档注释
- [ ] 完善README
- [ ] 完善部署文档

**验收标准**：
- 文档完整
- 文档与代码同步

---

#### 验收标准总结

- [ ] 单元测试通过率 > 80%
- [ ] 集成测试通过
- [ ] 压测结果满足需求（100并发用户）
- [ ] 性能指标达标
- [ ] 文档完整

---

#### 测试验证

```bash
# 1. 运行单元测试
pytest tests/ -v

# 2. 运行集成测试
pytest tests/integration/ -v

# 3. 运行压测
locust -f tests/locustfile.py --host=http://localhost:8000
```

---

## 三、开发顺序建议

### 3.1 推荐开发顺序

```
前提：✅ 脚手架项目已完成，且已支持 CookieCutter 模板

里程碑 1（项目基础搭建）
    ↓ 使用 CookieCutter 生成项目，选择 include_websocket=y
里程碑 2（IM核心 - 数据模型和仓储层）
    ↓
里程碑 3（IM核心 - 用户和群组服务 API）
    ↓
里程碑 4（IM核心 - 消息服务 API）
    ↓
里程碑 5（IM核心 - WebSocket 实时通信）
    ↓
里程碑 6（AI封装层 - AI交互服务）
    ↓
里程碑 7（测试和优化）
```

### 3.2 并行开发建议

- **里程碑 2 和里程碑 3**：可以部分并行（Schema 和 Repository 可以先完成）
- **里程碑 6**：可以在里程碑 5 完成后开始，与测试准备并行

### 3.3 关键依赖关系

- **里程碑 2** 依赖 **里程碑 1**：需要数据库表创建完成
- **里程碑 3** 依赖 **里程碑 2**：需要Repository层完成
- **里程碑 4** 依赖 **里程碑 3**：需要群组服务完成（消息需要群组）
- **里程碑 5** 依赖 **里程碑 4**：需要消息服务完成
- **里程碑 6** 依赖 **里程碑 5**：需要WebSocket服务完成（AI回复需要推送）
- **里程碑 7** 依赖 **里程碑 6**：需要所有功能完成

---

## 四、每个里程碑的交付物

### 4.1 代码交付物

- 源代码文件
- 测试文件
- 配置文件
- 数据库迁移脚本

### 4.2 文档交付物

- 代码注释
- API 文档更新
- 测试报告
- 问题记录

### 4.3 测试交付物

- 单元测试结果
- 集成测试结果
- 压测报告（里程碑 7）

---

## 五、风险控制

### 5.1 技术风险

- **AI服务调用失败**：实现重试机制和错误处理，AI服务不可用时不影响IM核心功能
- **WebSocket连接不稳定**：实现心跳机制和自动重连
- **数据库性能问题**：优化查询，添加索引

### 5.2 进度风险

- **AI服务集成复杂**：提前调研外部AI服务API规范
- **WebSocket实现复杂**：使用脚手架提供的WebSocket管理器
- **压测发现问题**：预留优化时间

---

## 六、开发环境准备

### 6.1 必需环境

- Python 3.10+
- PostgreSQL 14+ 或 MySQL 8.0+
- Redis 6.0+（可选，如果使用Celery）
- Git

### 6.2 开发工具

- IDE：VS Code / PyCharm
- 数据库管理工具：DBeaver / pgAdmin
- API 测试工具：Postman / curl
- 压测工具：Locust

### 6.3 脚手架准备

- **脚手架项目地址**：`/Users/m684620/work/github_GD25/gd25-arch-backend-python`
- **脚手架使用方式**：✅ **推荐使用 CookieCutter 模板**
  ```bash
  # 1. 安装 CookieCutter
  pip install cookiecutter
  
  # 2. 使用模板生成项目
  cookiecutter /Users/m684620/work/github_GD25/gd25-arch-backend-python/cookiecutter-gd25-arch-backend-python
  ```

---

## 七、验收标准总结

### 7.1 功能验收

- [ ] 用户可以发送消息
- [ ] 患者消息可以自动转发给AI服务
- [ ] 医生消息不会转发给AI服务
- [ ] AI回复可以正常创建和推送
- [ ] 消息可以正常存储和查询
- [ ] WebSocket实时推送正常
- [ ] 所有API接口正常工作

### 7.2 性能验收

- [ ] 支持 100 并发用户
- [ ] API 响应时间 < 200ms
- [ ] AI 回复时间 < 30s（取决于外部AI服务）
- [ ] 消息不丢失

### 7.3 质量验收

- [ ] 代码注释完整
- [ ] API 文档完整
- [ ] 测试覆盖率 > 80%
- [ ] 无严重 Bug

---

**文档版本**：v0.2  
**创建时间**：2025-01-27  
**最后更新**：2025-01-27  
**更新说明**：重新设计，实现IM核心与AI服务的完全解耦
