# IM 服务 - 项目总体设计（v0.2）

## 一、项目概述

### 1.1 项目背景

本项目是一个**轻量级即时通讯（IM）服务**，采用**核心+封装层**的架构设计：

- **IM核心**：专注于消息的收发、存储、查询等核心功能
- **AI封装层**：在核心外提供AI交互的定制化封装，实现与AI服务的解耦

### 1.2 设计原则

#### 1.2.1 核心与扩展分离

- ✅ **IM核心**：纯消息收发功能，不依赖AI服务
- ✅ **AI封装层**：可选的扩展层，通过接口与AI服务通信
- ✅ **完全解耦**：AI服务的变更不影响IM核心功能

#### 1.2.2 架构分层

```
┌─────────────────────────────────────┐
│  AI封装层（可选扩展）                │  ← 定制化AI交互逻辑
│  - AI交互服务                        │
│  - 用户身份识别                      │
│  - 消息路由规则                      │
└─────────────────────────────────────┘
              ↓ 调用
┌─────────────────────────────────────┐
│  IM核心层（核心功能）                │  ← 纯消息收发
│  - 消息收发                          │
│  - 消息存储                          │
│  - 群组管理                          │
│  - WebSocket通信                     │
└─────────────────────────────────────┘
```

### 1.3 核心需求

#### 1.3.1 IM核心功能

1. **消息收发**
   - 用户通过 WebSocket 或 HTTP API 发送消息
   - 消息的存储和查询
   - 实时消息推送（WebSocket）

2. **群组管理**
   - 群组创建和管理
   - 群组成员管理
   - 群组消息收发

3. **用户管理**
   - 用户身份标签（患者、医生、医生AI助手）
   - 用户信息管理

#### 1.3.2 AI封装层功能

1. **智能消息路由**
   - 根据用户身份标签判断是否需要AI处理
   - 普通用户（患者）消息 → 转发给AI服务
   - 医生消息 → 不转发给AI，直接处理

2. **AI交互管理**
   - 与外部AI服务通信（HTTP API）
   - AI回复消息的接收和处理
   - AI交互记录管理

### 1.4 功能范围

#### ✅ 核心功能

**IM核心层**：
- 用户发送消息（WebSocket + HTTP API）
- 消息存储和查询
- 群组管理（创建、加入、退出）
- 群组消息收发
- 实时消息推送（WebSocket）
- 用户身份标签管理

**AI封装层**：
- 用户身份识别（患者/医生/医生AI助手）
- 消息路由规则（根据身份决定是否转发AI）
- 与外部AI服务通信
- AI回复消息处理

#### ❌ 不包含功能

- 多端消息同步
- 离线消息推送
- 已读回执
- 消息撤回
- 复杂的权限管理
- AI服务的具体实现（由外部AI服务提供）

### 1.5 技术选型

```
技术栈：
├── FastAPI              # Web 框架（支持 WebSocket）
├── SQLAlchemy           # ORM 框架
├── Alembic              # 数据库迁移
├── Celery               # 异步任务队列（MQ，可选）
├── Redis                # 缓存和消息队列
├── PostgreSQL/MySQL     # 数据库
└── HTTP Client          # 与外部AI服务通信
```

**注意**：不直接依赖 LangChain 等AI框架，通过HTTP API与外部AI服务通信。

---

## 二、系统架构设计

### 2.1 整体架构

```
┌─────────────┐
│  客户端     │ (WebSocket / HTTP)
└──────┬──────┘
       │
       ↓
┌─────────────────────────────────────┐
│  FastAPI 服务                       │
│  ┌───────────────────────────────┐  │
│  │  AI封装层（可选扩展）          │  │
│  │  ┌─────────────────────────┐  │  │
│  │  │ AI交互服务              │  │  │
│  │  │ - 用户身份识别          │  │  │
│  │  │ - 消息路由规则          │  │  │
│  │  │ - AI服务调用            │  │  │
│  │  └───────────┬────────────┘  │  │
│  └──────────────┼────────────────┘  │
│                 │                     │
│  ┌──────────────┴─────────────────┐  │
│  │  IM核心层                       │  │
│  │  ┌─────────────────────────┐  │  │
│  │  │ 消息服务                 │  │  │
│  │  │ - 消息接收               │  │  │
│  │  │ - 消息存储               │  │  │
│  │  │ - 消息查询               │  │  │
│  │  └───────────┬────────────┘  │  │
│  │              │                 │  │
│  │  ┌───────────┴────────────┐  │  │
│  │  │ 群组服务                │  │  │
│  │  │ - 群组管理              │  │  │
│  │  │ - 成员管理              │  │  │
│  │  └───────────┬────────────┘  │  │
│  │              │                 │  │
│  │  ┌───────────┴────────────┐  │  │
│  │  │ WebSocket服务           │  │  │
│  │  │ - 连接管理              │  │  │
│  │  │ - 消息推送              │  │  │
│  │  └───────────┬────────────┘  │  │
│  └──────────────┼────────────────┘  │
└─────────────────┼─────────────────────┘
                  │
                  ↓
┌─────────────────────────────────────┐
│  数据库 (PostgreSQL)                │
│  ┌───────────────────────────────┐  │
│  │ 消息表                         │  │
│  │ 群组表                         │  │
│  │ 群组成员表                     │  │
│  │ 用户表                         │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
                  │
                  ↓
┌─────────────────────────────────────┐
│  外部AI服务（HTTP API）             │  ← 完全解耦
│  - 独立的AI服务                     │
│  - 通过HTTP API通信                 │
│  - 不依赖IM服务                     │
└─────────────────────────────────────┘
```

### 2.2 核心流程

#### 2.2.1 普通用户（患者）发送消息流程

```
1. 患者通过 WebSocket 或 HTTP API 发送消息
   ↓
2. FastAPI 接收消息
   ↓
3. AI封装层：识别用户身份（患者）
   ↓
4. AI封装层：判断需要转发给AI服务
   ↓
5. IM核心层：保存消息到数据库
   ↓
6. AI封装层：异步调用外部AI服务（HTTP API）
   ↓
7. 立即返回响应给用户（消息已发送）
   ↓
8. AI服务返回回复
   ↓
9. AI封装层：接收AI回复，创建AI助手消息
   ↓
10. IM核心层：保存AI回复消息到数据库
   ↓
11. IM核心层：通过WebSocket推送AI回复给群组所有成员
```

#### 2.2.2 医生发送消息流程

```
1. 医生通过 WebSocket 或 HTTP API 发送消息
   ↓
2. FastAPI 接收消息
   ↓
3. AI封装层：识别用户身份（医生）
   ↓
4. AI封装层：判断不需要转发给AI服务
   ↓
5. IM核心层：保存消息到数据库
   ↓
6. IM核心层：通过WebSocket推送消息给群组所有成员
   ↓
7. 立即返回响应给用户（消息已发送）
```

#### 2.2.3 AI助手发送消息流程

```
1. AI助手（系统）发送消息
   ↓
2. IM核心层：保存消息到数据库
   ↓
3. IM核心层：通过WebSocket推送消息给群组所有成员
   ↓
（AI助手消息由AI封装层在收到AI服务回复后自动创建）
```

### 2.3 技术架构分层

```
┌─────────────────────────────────────┐
│  表现层 (Presentation Layer)        │
│  - FastAPI HTTP API                 │
│  - WebSocket Handler                │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  AI封装层 (AI Integration Layer)    │  ← 可选扩展层
│  - AI交互服务                        │
│  - 用户身份识别                      │
│  - 消息路由规则                      │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  业务层 (Business Layer)            │
│  - MessageService（IM核心）        │
│  - GroupService（IM核心）          │
│  - UserService（IM核心）           │
│  - WebSocketService（IM核心）       │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  数据访问层 (Data Access Layer)     │
│  - MessageRepository                │
│  - GroupRepository                  │
│  - UserRepository                  │
│  - GroupMemberRepository            │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  基础设施层 (Infrastructure Layer)  │
│  - Database (PostgreSQL)            │
│  - Redis (MQ，可选)                 │
│  - Celery（可选）                   │
│  - HTTP Client（AI服务通信）        │
└─────────────────────────────────────┘
```

---

## 三、模块划分

### 3.1 IM核心模块

#### 3.1.1 消息服务模块
- 消息接收和处理
- 消息存储
- 消息查询
- **不依赖AI服务**

#### 3.1.2 群组服务模块
- 群组创建和管理
- 群组成员管理
- 群组消息收发
- **不依赖AI服务**

#### 3.1.3 用户服务模块
- 用户信息管理
- 用户身份标签管理（患者、医生、医生AI助手）
- **不依赖AI服务**

#### 3.1.4 WebSocket服务模块
- WebSocket连接管理
- 实时消息推送
- **不依赖AI服务**

### 3.2 AI封装层模块

#### 3.2.1 AI交互服务模块
- 与外部AI服务通信（HTTP API）
- AI回复消息处理
- AI交互记录管理
- **通过HTTP API与外部AI服务通信，不直接依赖AI框架**

#### 3.2.2 消息路由服务模块
- 用户身份识别
- 消息路由规则判断
- 决定是否转发给AI服务
- **依赖用户服务模块**

### 3.3 模块依赖关系

```
AI封装层模块
    ↓ 依赖
IM核心模块（消息服务、群组服务、用户服务）
    ↓ 依赖
数据访问模块
    ↓ 依赖
数据库

AI封装层模块
    ↓ 调用（HTTP API）
外部AI服务
    （完全解耦，不依赖IM服务）
```

**关键点**：
- ✅ IM核心模块**不依赖**AI封装层
- ✅ AI封装层**依赖**IM核心模块
- ✅ AI封装层通过**HTTP API**与外部AI服务通信
- ✅ 外部AI服务**完全独立**，不依赖IM服务

---

## 四、数据库设计

### 4.1 数据库选型

- **主数据库**：PostgreSQL（推荐）或 MySQL
- **缓存/消息队列**：Redis（可选）

### 4.2 核心表设计

#### 4.2.1 用户表 (users)

```sql
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    user_id VARCHAR(48) NOT NULL UNIQUE COMMENT '用户唯一标识',
    username VARCHAR(64) NOT NULL COMMENT '用户名',
    user_role VARCHAR(32) NOT NULL DEFAULT 'PATIENT' COMMENT '用户身份：PATIENT(患者)/DOCTOR(医生)/AI_ASSISTANT(医生AI助手)',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_user_role (user_role)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

#### 4.2.2 群组表 (groups)

```sql
CREATE TABLE groups (
    id BIGSERIAL PRIMARY KEY,
    group_id VARCHAR(64) NOT NULL UNIQUE COMMENT '群组唯一标识',
    group_name VARCHAR(128) NOT NULL COMMENT '群组名称',
    description TEXT COMMENT '群组描述',
    created_by VARCHAR(48) NOT NULL COMMENT '创建人ID',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_group_id (group_id),
    INDEX idx_created_by (created_by)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='群组表';
```

#### 4.2.3 群组成员表 (group_members)

```sql
CREATE TABLE group_members (
    id BIGSERIAL PRIMARY KEY,
    group_id VARCHAR(64) NOT NULL COMMENT '群组ID',
    user_id VARCHAR(48) NOT NULL COMMENT '用户ID',
    user_role VARCHAR(32) NOT NULL COMMENT '用户在群组中的身份标签',
    joined_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE KEY uk_group_user (group_id, user_id),
    INDEX idx_group_id (group_id),
    INDEX idx_user_id (user_id),
    INDEX idx_user_role (user_role)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='群组成员表';
```

#### 4.2.4 消息表 (messages)

```sql
CREATE TABLE messages (
    id BIGSERIAL PRIMARY KEY,
    message_id VARCHAR(64) NOT NULL UNIQUE COMMENT '消息唯一标识',
    group_id VARCHAR(64) NOT NULL COMMENT '群组ID',
    from_user_id VARCHAR(48) NOT NULL COMMENT '发送人ID',
    msg_type VARCHAR(32) NOT NULL DEFAULT 'TEXT' COMMENT '消息类型：TEXT/IMAGE/AI_REPLY',
    msg_content TEXT NOT NULL COMMENT '消息内容',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_group_id (group_id),
    INDEX idx_from_user_id (from_user_id),
    INDEX idx_created_at (created_at),
    INDEX idx_group_created (group_id, created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='消息表';
```

#### 4.2.5 AI交互记录表 (ai_interaction_records)

```sql
CREATE TABLE ai_interaction_records (
    id BIGSERIAL PRIMARY KEY,
    record_id VARCHAR(64) NOT NULL UNIQUE COMMENT '记录唯一标识',
    group_id VARCHAR(64) NOT NULL COMMENT '群组ID',
    user_message_id VARCHAR(64) NOT NULL COMMENT '用户消息ID',
    ai_message_id VARCHAR(64) COMMENT 'AI回复消息ID',
    ai_service_url VARCHAR(256) COMMENT 'AI服务URL',
    request_content TEXT COMMENT '请求内容（JSON格式）',
    response_content TEXT COMMENT '响应内容（JSON格式）',
    status TINYINT NOT NULL DEFAULT 0 COMMENT '状态：0-处理中，1-成功，2-失败',
    duration_ms BIGINT COMMENT '处理耗时（毫秒）',
    error_message VARCHAR(500) COMMENT '错误信息',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_group_id (group_id),
    INDEX idx_user_message_id (user_message_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='AI交互记录表';
```

---

## 五、API 设计概览

### 5.1 HTTP API

#### IM核心API
- `POST /api/message/send` - 发送消息
- `GET /api/message/list` - 获取消息列表
- `GET /api/message/{message_id}` - 获取单条消息
- `POST /api/group/create` - 创建群组
- `GET /api/group/{group_id}` - 获取群组信息
- `POST /api/group/{group_id}/members` - 添加群组成员
- `GET /api/group/{group_id}/members` - 获取群组成员列表
- `GET /api/user/{user_id}` - 获取用户信息
- `PUT /api/user/{user_id}/role` - 更新用户身份标签

#### AI封装层API（可选）
- `GET /api/ai/interactions` - 获取AI交互记录
- `POST /api/ai/test` - 测试AI服务连接

### 5.2 WebSocket API

- `ws://host/ws/{user_id}` - WebSocket 连接
- 消息格式：JSON

详细 API 文档见：`03-API接口文档.md`

---

## 六、非功能性需求

### 6.1 性能要求

- **响应时间**：HTTP API 响应时间 < 200ms
- **并发支持**：支持至少 100 并发用户
- **AI 回复时间**：AI 回复生成时间 < 30s（取决于外部AI服务）

### 6.2 可靠性要求

- **可用性**：99% 可用性
- **数据一致性**：保证消息不丢失
- **错误处理**：完善的错误处理和日志记录
- **AI服务降级**：AI服务不可用时，不影响IM核心功能

### 6.3 可扩展性

- **水平扩展**：支持多实例部署
- **AI服务切换**：支持切换不同的AI服务提供商
- **数据库扩展**：支持数据库读写分离

---

## 七、开发环境要求

### 7.1 开发工具

- **Python 3.11**（固定版本，必须）
- PostgreSQL 14+ 或 MySQL 8.0+
- Redis 6.0+（可选）
- Git

### 7.2 Python 依赖

- FastAPI 0.104+
- SQLAlchemy 2.0+
- Celery 5.3+（可选）
- Redis 5.0+（可选）
- Pydantic 2.0+
- httpx（AI服务HTTP通信）

**注意**：不直接依赖 LangChain 等AI框架。

---

## 八、部署架构

### 8.1 开发环境

```
单机部署：
├── FastAPI 服务（端口 8000）
├── PostgreSQL（本地）
├── Redis（本地，可选）
└── 外部AI服务（独立部署或使用第三方服务）
```

### 8.2 生产环境（可选）

```
多实例部署：
├── FastAPI 服务（Nginx 负载均衡）
├── PostgreSQL（主从复制）
├── Redis（集群模式，可选）
└── 外部AI服务（独立服务，可独立扩展）
```

---

## 九、安全考虑

### 9.1 认证授权

- **用户认证**：支持 Token 认证（JWT）
- **WebSocket 认证**：连接时验证 Token
- **AI服务认证**：AI服务API密钥管理

### 9.2 数据安全

- **数据加密**：敏感数据加密存储
- **SQL 注入防护**：使用 ORM 防止 SQL 注入
- **XSS 防护**：输入验证和转义

---

## 十、监控和日志

### 10.1 日志

- **日志级别**：DEBUG、INFO、WARNING、ERROR
- **日志格式**：JSON 格式，便于分析
- **日志存储**：文件 + 可选 ELK 栈

### 10.2 监控指标

- **API 响应时间**
- **消息处理量**
- **AI服务调用成功率**
- **AI服务响应时间**
- **数据库连接数**

---

## 十一、脚手架集成说明

### 11.1 脚手架模块使用

本项目基于 `gd25-arch-backend-python` 脚手架开发，使用脚手架提供的以下模块：

- **配置管理**：使用脚手架配置模块
- **数据库连接**：使用脚手架数据库模块
- **基础模型**：继承脚手架 BaseModel（id, created_at, updated_at）
- **日志工具**：使用脚手架日志工具
- **ID 生成器**：使用脚手架 ID 生成器
- **依赖注入**：使用脚手架依赖注入模式
- **主应用入口**：基于脚手架主应用，注册业务路由
- **Celery 配置**：使用脚手架 Celery 配置（可选）
- **WebSocket 管理器**：使用脚手架 WebSocket 管理器（可选）

### 11.2 业务模块开发

本项目需要开发的业务模块：

**IM核心模块**：
- 数据模型：User、Group、GroupMember、Message
- Schema：UserCreate、GroupCreate、MessageCreate等
- Repository：UserRepository、GroupRepository、MessageRepository等
- 服务层：UserService、GroupService、MessageService、WebSocketService
- API 路由：用户API、群组API、消息API

**AI封装层模块**：
- 服务层：AIInteractionService、MessageRouterService
- API 路由：AI交互API（可选）

---

**文档版本**：v0.2  
**创建时间**：2025-01-27  
**更新说明**：重新设计，实现IM核心与AI服务的完全解耦
